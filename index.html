<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>AR-GEO – Hình học không gian THCS & THPT</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;overflow:hidden;font-family:Arial}
#ui{
 position:fixed;top:10px;left:10px;
 background:rgba(255,255,255,0.97);
 padding:10px;border-radius:12px;
 width:260px;z-index:10
}
select,button{width:100%;margin-top:6px;padding:6px}
#info{font-size:13px;margin-top:6px;line-height:1.4}
</style>
</head>

<body>
<div id="ui">
<select id="shape">
<option value="cube">Lập phương</option>
<option value="triPrism">Lăng trụ tam giác</option>
<option value="pyramid">Chóp tứ giác</option>
<option value="cylinder">Hình trụ</option>
<option value="cone">Hình nón</option>
<option value="sphere">Hình cầu</option>
</select>

<button id="rotateBtn">Bật / tắt xoay</button>
<button id="measureBtn">Đo cạnh AR</button>
<button id="netBtn">Trải Net</button>

<div id="info"></div>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js";
import { ARButton } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/webxr/ARButton.js";

let scene,camera,renderer;
let model,faces=[];
let autoRotate=false;
let measuring=false,points=[];

init(); animate();

function init(){
 scene=new THREE.Scene();
 camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.01,20);

 renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
 renderer.setSize(innerWidth,innerHeight);
 renderer.xr.enabled=true;
 document.body.appendChild(renderer.domElement);
 document.body.appendChild(ARButton.createButton(renderer));

 scene.add(new THREE.HemisphereLight(0xffffff,0xbbbbff,1.2));

 shape.onchange=createShape;
 rotateBtn.onclick=()=>autoRotate=!autoRotate;
 measureBtn.onclick=()=>measuring=!measuring;
 netBtn.onclick=toggleNet;

 renderer.domElement.addEventListener("pointerdown",onTap);

 createShape();
 window.addEventListener("resize",resize);
}

function createShape(){
 if(model) scene.remove(model);
 faces=[];

 let g,info="";
 switch(shape.value){
  case "cube":
   g=new THREE.BoxGeometry(0.15,0.15,0.15);
   info="LẬP PHƯƠNG<br>S = 6a²<br>V = a³"; break;

  case "triPrism":
   g=new THREE.CylinderGeometry(0.08,0.08,0.18,3);
   info="LĂNG TRỤ TAM GIÁC<br>V = Sđ · h"; break;

  case "pyramid":
   g=new THREE.ConeGeometry(0.1,0.18,4);
   info="CHÓP TỨ GIÁC<br>V = 1/3 · Sđ · h"; break;

  case "cylinder":
   g=new THREE.CylinderGeometry(0.08,0.08,0.18,32);
   info="HÌNH TRỤ<br>V = πr²h"; break;

  case "cone":
   g=new THREE.ConeGeometry(0.09,0.18,32);
   info="HÌNH NÓN<br>V = 1/3πr²h"; break;

  case "sphere":
   g=new THREE.SphereGeometry(0.1,32,32);
   info="HÌNH CẦU<br>V = 4/3πr³"; break;
 }

 infoDiv(info);

 g.clearGroups();
 const faceCount=g.index.count/3;
 for(let i=0;i<faceCount;i++) g.addGroup(i*3,3,i);

 const mats=[];
 for(let i=0;i<faceCount;i++)
  mats.push(new THREE.MeshStandardMaterial({
   color: i===0 ? 0x4f83ff : 0x6bd968,
   transparent:true,opacity:0.9
  }));

 model=new THREE.Mesh(g,mats);
 model.position.set(0,0,-0.6);
 scene.add(model);

 faces=model.material;
}

function toggleNet(){
 if(!faces.length) return;
 faces.forEach((m,i)=>{
  m.opacity = m.opacity===0.9 ? 0.4 : 0.9;
 });
}

function onTap(event){
 if(!measuring) return;

 const x=(event.clientX/innerWidth)*2-1;
 const y=-(event.clientY/innerHeight)*2+1;
 const ray=new THREE.Raycaster();
 ray.setFromCamera({x,y},camera);

 const p=new THREE.Vector3();
 ray.ray.at(0.6,p);
 points.push(p.clone());

 if(points.length===2){
  const d=points[0].distanceTo(points[1]).toFixed(2);
  infoDiv(info.innerHTML+"<br>Đo AR ≈ "+d+" m");
  points=[];
 }
}

function infoDiv(t){ document.getElementById("info").innerHTML=t; }

function animate(){
 renderer.setAnimationLoop(()=>{
  if(model && autoRotate) model.rotation.y+=0.01;
  renderer.render(scene,camera);
 });
}

function resize(){
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
}
</script>
</body>
</html>
