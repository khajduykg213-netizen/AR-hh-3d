<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>AR Hình học 3D – Net – Đo cạnh</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;overflow:hidden;font-family:Arial}
#ui{
 position:fixed;top:10px;left:10px;
 background:rgba(255,255,255,0.97);
 padding:10px;border-radius:12px;
 max-width:260px;z-index:10
}
select,button{width:100%;margin-top:6px;padding:6px}
#info{font-size:13px;margin-top:6px;line-height:1.4}
</style>
</head>

<body>
<div id="ui">
<select id="shape">
<option value="cube">Lập phương</option>
<option value="box">Hộp chữ nhật</option>
<option value="cylinder">Hình trụ</option>
<option value="cone">Hình nón</option>
</select>

<button id="netBtn">Trải Net</button>
<button id="measureBtn">Đo cạnh AR</button>
<div id="info"></div>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160/build/three.module.js";
import { ARButton } from "https://cdn.jsdelivr.net/npm/three@0.160/examples/jsm/webxr/ARButton.js";

let scene,camera,renderer;
let model,labels=[];
let measuring=false,points=[],line;

init(); animate();

function init(){
 scene=new THREE.Scene();
 camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.01,20);
 renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
 renderer.setSize(innerWidth,innerHeight);
 renderer.xr.enabled=true;
 document.body.appendChild(renderer.domElement);
 document.body.appendChild(ARButton.createButton(renderer));

 scene.add(new THREE.HemisphereLight(0xffffff,0xbbbbff,1.2));

 shape.onchange=createShape;
 netBtn.onclick=toggleNet;
 measureBtn.onclick=()=>measuring=!measuring;

 renderer.domElement.addEventListener("pointerdown",onTap);
 createShape();
 window.addEventListener("resize",resize);
}

function createShape(){
 clearScene();
 let g,info="";
 if(shape.value==="cube"){
  g=new THREE.BoxGeometry(0.15,0.15,0.15);
  info="a";
  addLabel("a",0,0.09,0);
 }
 if(shape.value==="box"){
  g=new THREE.BoxGeometry(0.18,0.12,0.1);
  addLabel("a",0.1,0,0);
  addLabel("b",0,0.07,0);
  addLabel("c",0,0,0.07);
 }
 if(shape.value==="cylinder"){
  g=new THREE.CylinderGeometry(0.07,0.07,0.18,32);
  addLabel("r",0.08,0,0);
  addLabel("h",0,0.1,0);
 }
 if(shape.value==="cone"){
  g=new THREE.ConeGeometry(0.08,0.18,32);
  addLabel("r",0.08,0,0);
  addLabel("h",0,0.1,0);
 }

 model=new THREE.Mesh(g,new THREE.MeshStandardMaterial({
  color:0x4fc3f7,transparent:true,opacity:0.9
 }));
 model.position.set(0,0,-0.6);
 scene.add(model);
 infoDiv(info);
}

function addLabel(text,x,y,z){
 const canvas=document.createElement("canvas");
 canvas.width=256; canvas.height=128;
 const ctx=canvas.getContext("2d");
 ctx.fillStyle="red";
 ctx.font="48px Arial";
 ctx.fillText(text,100,70);
 const tex=new THREE.CanvasTexture(canvas);
 const spr=new THREE.Sprite(new THREE.SpriteMaterial({map:tex}));
 spr.scale.set(0.15,0.07,1);
 spr.position.set(x,y,z);
 labels.push(spr);
 scene.add(spr);
}

function onTap(e){
 if(!measuring) return;
 const p=new THREE.Vector3(0,0,-0.5).applyMatrix4(camera.matrixWorld);
 points.push(p.clone());
 if(points.length===2){
  const g=new THREE.BufferGeometry().setFromPoints(points);
  line=new THREE.Line(g,new THREE.LineBasicMaterial({color:0xff0000}));
  scene.add(line);
  const d=points[0].distanceTo(points[1]).toFixed(2);
  infoDiv("Độ dài ≈ "+d+" m");
  points=[];
 }
}

let net=false;
function toggleNet(){
 if(!model) return;
 net=!net;
 model.children.forEach((m,i)=>{
  if(m.position){
   m.position.x=net?i*0.18:0;
  }
 });
}

function clearScene(){
 if(model) scene.remove(model);
 labels.forEach(l=>scene.remove(l));
 labels=[];
 if(line) scene.remove(line);
}

function infoDiv(t){ document.getElementById("info").innerHTML=t; }

function animate(){
 renderer.setAnimationLoop(()=>renderer.render(scene,camera));
}

function resize(){
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
}
</script>
</body>
</html>
